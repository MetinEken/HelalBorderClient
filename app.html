<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Helal Border</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Çevre değişkenleri ve giriş kontrolü için gerekli dosyalar -->
    <script src="env.js"></script>
    <script src="auth.js"></script>
    <!-- Material UI CSS ve JS dosyaları -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <style>
      body {
        font-family: "Roboto", "Segoe UI", sans-serif;
        background-color: #f2f4f8;
        margin: 0;
        padding: 0;
        overflow-y: auto;
      }

      .header {
        background-color: #007bff;
        color: white;
        padding: 1rem 2rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .logout-button {
        position: absolute;
        right: 2rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        font-size: 0.9rem;
      }
      
      .logout-button:hover {
        text-decoration: underline;
      }

      .tab-container {
        max-width: 1200px;
        margin: 2rem auto;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .tabs {
        display: flex;
        background-color: #f5f5f5;
        border-bottom: 1px solid #ddd;
      }

      .tab {
        padding: 1rem 1.5rem;
        cursor: pointer;
        transition: background-color 0.3s;
        font-weight: 500;
        text-align: center;
        flex: 1;
      }

      .tab:hover {
        background-color: #e0e0e0;
      }

      .tab.active {
        background-color: #fff;
        border-bottom: 3px solid #007bff;
        color: #007bff;
      }

      .tab-content {
        display: none;
        padding: 2rem;
        max-height: calc(100vh - 180px);
        overflow-y: auto;
      }

      .tab-content.active {
        display: block;
      }

      /* Yapay Zeka Kelimeleri Tab Stilleri */
      .container {
        max-width: 800px;
        margin: auto;
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
      }

      h1, h2 {
        text-align: center;
        color: #333;
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-top: 1.5rem;
        font-weight: 600;
        color: #333;
      }

      textarea {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        resize: vertical;
        min-height: 30rem;
      }

      button {
        margin-top: 2rem;
        width: 100%;
        padding: 1rem;
        background-color: #007bff;
        color: white;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background-color: #0056b3;
      }

      #response {
        margin-top: 1.5rem;
        background-color: #f8f9fa;
        border-left: 4px solid #28a745;
        padding: 1rem;
        white-space: pre-wrap;
      }

      .empty-tab {
        text-align: center;
        padding: 3rem;
        color: #666;
      }
      
      /* Barcode Kelimeler bölümü için stiller */
      .barcode-container {
        max-width: 900px;
        margin: 0 auto;
      }
      
      .sub-tabs {
        display: flex;
        flex-wrap: wrap;
        background-color: #f5f5f5;
        border-bottom: 1px solid #ddd;
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
      }
      
      .sub-tab {
        padding: 0.8rem 1.2rem;
        cursor: pointer;
        transition: background-color 0.3s;
        font-weight: 500;
        text-align: center;
        flex: 1;
        min-width: 120px;
        font-size: 0.9rem;
      }
      
      .sub-tab:hover {
        background-color: #e0e0e0;
      }
      
      .sub-tab.active {
        background-color: #fff;
        border-bottom: 3px solid #007bff;
        color: #007bff;
      }
      
      .sub-tab-content {
        display: none;
        padding: 1.5rem;
        background-color: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        max-height: calc(100vh - 300px);
        overflow-y: auto;
      }
      
      .sub-tab-content.active {
        display: block;
      }
      
      .content-box {
        margin-bottom: 2rem;
      }
      
      .content-box h3 {
        margin-bottom: 1rem;
        color: #333;
      }
      
      .content-box textarea {
        width: 100%;
        min-height: 200px;
        margin-bottom: 1rem;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }
      
      .save-button {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }
      
      .save-button:hover {
        background-color: #218838;
      }
      
      /* Token Kullanım bölümü için stiller */
      .token-container {
        max-width: 900px;
        margin: 0 auto;
      }
      
      .token-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }
      
      .stat-box {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        text-align: center;
        min-width: 200px;
        margin: 1rem;
      }
      
      .stat-box h3 {
        margin-top: 0;
        color: #333;
        font-size: 1.2rem;
      }
      
      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
        margin-top: 1rem;
      }
      
      .token-table-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        overflow-x: auto;
      }
      
      .token-table {
        width: 100%;
        border-collapse: collapse;
      }
      
      .token-table th,
      .token-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      
      .token-table th {
        background-color: #f5f5f5;
        font-weight: 600;
        color: #333;
      }
      
      .token-table tbody tr:hover {
        background-color: #f9f9f9;
      }
      
      .loading-message {
        text-align: center;
        color: #666;
        padding: 2rem;
      }
      
      /* Grafik stilleri */
      .chart-container {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
      }
      
      .chart-container h3 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
      }
      
      .chart {
        height: 250px;
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        padding: 0 1rem;
        border-bottom: 2px solid #ddd;
        position: relative;
      }
      
      .chart::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 2px;
        background-color: #ddd;
      }
      
      .chart-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #666;
      }
      
      .chart-bar-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 12%;
      }
      
      .chart-date {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.5rem;
        text-align: center;
        transform: rotate(-45deg);
        white-space: nowrap;
        width: 100%;
        height: 40px;
      }
      
      .chart-bars {
        display: flex;
        width: 100%;
        height: 100%;
        align-items: flex-end;
        justify-content: center;
      }
      
      .chart-bar {
        width: 40%;
        margin: 0 5%;
        transition: height 0.3s ease;
      }
      
      .token-bar {
        background-color: #007bff;
      }
      
      .check-bar {
        background-color: #28a745;
      }
      
      .chart-legend {
        display: flex;
        justify-content: center;
        margin-top: 3rem;
      }
      
      .legend-item {
        display: flex;
        align-items: center;
        margin: 0 1rem;
      }
      
      .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 0.5rem;
        border-radius: 4px;
      }
      
      .token-color {
        background-color: #007bff;
      }
      
      .check-color {
        background-color: #28a745;
      }
      
      .chart-y-axis {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        pointer-events: none;
      }
      
      .y-axis-label {
        font-size: 0.7rem;
        color: #666;
        transform: translateX(-50%);
        text-align: right;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Helal Border</h1>
      <div class="logout-button" onclick="logout()">
        <i class="material-icons">exit_to_app</i> Çıkış
      </div>
    </div>

    <div class="tab-container">
      <div class="tabs">
        <div class="tab" data-tab="tab1">Yapay Zeka Kelimeleri</div>
        <div class="tab" data-tab="tab2">Barcode Kelimeler</div>
        <div class="tab" data-tab="tab3">Token Kullanım</div>
        <div class="tab" data-tab="tab4">Hata Bildirimleri</div>
      </div>

      <!-- Tab 1: Yapay Zeka Kelimeleri (Mevcut içerik) -->
      <div id="tab1" class="tab-content">
        <div class="container">
          <h2>Helal Kontrol Bilgilerini Güncelle</h2>
          <form id="helalForm">
            <label for="baseTalimat">Base Talimat:</label>
            <textarea id="baseTalimat" required></textarea>

            <label for="detayliTalimat">Detaylı Talimat:</label>
            <textarea id="detayliTalimat" required></textarea>

            <label for="eCode">E Kodu:</label>
            <textarea id="eCode"></textarea>

            <label for="alcoholWords">Alkol Kelimeleri:</label>
            <textarea id="alcoholWords"></textarea>

            <label for="containingAlcohol">İçeren Alkol:</label>
            <textarea id="containingAlcohol"></textarea>

            <label for="animalProduct">Hayvansal Ürün:</label>
            <textarea id="animalProduct"></textarea>

            <label for="notConsideredAlcohol">Alkol Sayılmayanlar:</label>
            <textarea id="notConsideredAlcohol"></textarea>

            <button type="submit">Güncelle</button>
          </form>

          <div id="response"></div>
          <div id="formalizeResponse" style="margin-top: 1rem; color: #28a745"></div>
        </div>
      </div>

      <!-- Tab 2: Barcode Kelimeler -->
      <div id="tab2" class="tab-content">
        <div class="barcode-container">
          <h2>Barcode Kelimeler</h2>
          
          <!-- Barcode Kelimeler için alt tablar -->
          <div class="sub-tabs">
            <div class="sub-tab active" data-subtab="subtab1">Alkol İçerik</div>
            <div class="sub-tab" data-subtab="subtab2">Hayvansal İçerik</div>
            <div class="sub-tab" data-subtab="subtab3">E-Code</div>
            <div class="sub-tab" data-subtab="subtab4">Non-Alkol</div>
            <div class="sub-tab" data-subtab="subtab5">Domuz-Ürünleri</div>
            <div class="sub-tab" data-subtab="subtab6">Helal-Hayvansal</div>
          </div>
          
          <!-- Alt tab içerikleri -->
          <div class="sub-tab-contents">
            <!-- Alkol İçerik -->
            <div id="subtab1" class="sub-tab-content active">
              <div class="content-box">
                <h3>Alkol İçeren Maddeler</h3>
                <p>Bu bölümde alkol içeren maddelerin listesi yer alacaktır.</p>
                <textarea id="alcoholContent" placeholder="Alkol içeren maddeleri buraya ekleyin..."></textarea>
                <button class="save-button">Kaydet</button>
              </div>
            </div>
            
            <!-- Hayvansal İçerik -->
            <div id="subtab2" class="sub-tab-content">
              <div class="content-box">
                <h3>Hayvansal İçerikler</h3>
                <p>Bu bölümde hayvansal içeriklerin listesi yer alacaktır.</p>
                <textarea id="animalContent" placeholder="Hayvansal içerikleri buraya ekleyin..."></textarea>
                <button class="save-button">Kaydet</button>
              </div>
            </div>
            
            <!-- E-Code -->
            <div id="subtab3" class="sub-tab-content">
              <div class="content-box">
                <h3>E-Kodlar</h3>
                <p>Bu bölümde E-Kodların listesi yer alacaktır.</p>
                <textarea id="eCodeContent" placeholder="E-Kodları buraya ekleyin..."></textarea>
                <button class="save-button">Kaydet</button>
              </div>
            </div>
            
            <!-- Non-Alkol -->
            <div id="subtab4" class="sub-tab-content">
              <div class="content-box">
                <h3>Non-Alkol İçerikler</h3>
                <p>Bu bölümde alkol sayılmayan maddelerin listesi yer alacaktır.</p>
                <textarea id="nonAlcoholContent" placeholder="Alkol sayılmayan maddeleri buraya ekleyin..."></textarea>
                <button class="save-button">Kaydet</button>
              </div>
            </div>
            
            <!-- Domuz-Ürünleri -->
            <div id="subtab5" class="sub-tab-content">
              <div class="content-box">
                <h3>Domuz Ürünleri</h3>
                <p>Bu bölümde domuz ürünlerinin listesi yer alacaktır.</p>
                <textarea id="porkContent" placeholder="Domuz ürünlerini buraya ekleyin..."></textarea>
                <button class="save-button">Kaydet</button>
              </div>
            </div>
            
            <!-- Helal-Hayvansal -->
            <div id="subtab6" class="sub-tab-content">
              <div class="content-box">
                <h3>Helal Hayvansal Ürünler</h3>
                <p>Bu bölümde helal hayvansal ürünlerin listesi yer alacaktır.</p>
                <textarea id="halalAnimalContent" placeholder="Helal hayvansal ürünleri buraya ekleyin..."></textarea>
                <button class="save-button">Kaydet</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 3: Token Kullanım -->
      <div id="tab3" class="tab-content">
        <div class="token-container">
          <h2>Token Kullanım</h2>
          
          <!-- Toplam İstatistikler -->
          <div class="token-stats">
            <div class="stat-box">
              <h3>Toplam Token Sayısı</h3>
              <div class="stat-value" id="totalTokenSum">Yükleniyor...</div>
            </div>
            <div class="stat-box">
              <h3>Toplam Kontrol Sayısı</h3>
              <div class="stat-value" id="totalCheckCallSum">Yükleniyor...</div>
            </div>
          </div>
          
          <!-- Son 1 Haftalık Grafik -->
          <div class="chart-container">
            <h3>Son 1 Haftalık Token Kullanımı</h3>
            <div class="chart" id="tokenChart">
              <div class="chart-loading">Grafik yükleniyor...</div>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <div class="legend-color token-color"></div>
                <div>Token Sayısı</div>
              </div>
              <div class="legend-item">
                <div class="legend-color check-color"></div>
                <div>Kontrol Sayısı</div>
              </div>
            </div>
          </div>
          
          <!-- Token Kullanım Tablosu -->
          <div class="token-table-container">
            <table class="token-table">
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Token Sayısı</th>
                  <th>Kontrol Sayısı</th>
                </tr>
              </thead>
              <tbody id="tokenTableBody">
                <tr>
                  <td colspan="3" class="loading-message">Veriler yükleniyor...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab 4: Hata Bildirimleri -->
      <div id="tab4" class="tab-content">
        <div class="empty-tab">
          <h2>Hata Bildirimleri</h2>
          <p>Bu bölüm henüz hazırlanmaktadır.</p>
        </div>
      </div>
    </div>
    
    <script>
      // Tab işlevselliği
      document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const subTabs = document.querySelectorAll('.sub-tab');
        const subTabContents = document.querySelectorAll('.sub-tab-content');
        
        // İlk açılışta 4. tab'ı aktif yap
        activateTab('tab4');
        
        tabs.forEach(tab => {
          tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            activateTab(tabId);
          });
        });
        
        // Alt tablar için tıklama olayı
        subTabs.forEach(subTab => {
          subTab.addEventListener('click', function() {
            const subTabId = this.getAttribute('data-subtab');
            activateSubTab(subTabId);
          });
        });
        
        function activateTab(tabId) {
          // Tüm tabları ve içeriklerini deaktif yap
          tabs.forEach(tab => tab.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Seçilen tabı ve içeriğini aktif yap
          document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
          document.getElementById(tabId).classList.add('active');
          
          // Eğer Barcode Kelimeler tabı seçildiyse, ilk alt tabı aktif yap
          if (tabId === 'tab2') {
            activateSubTab('subtab1');
          }
        }
        
        function activateSubTab(subTabId) {
          // Tüm alt tabları ve içeriklerini deaktif yap
          subTabs.forEach(subTab => subTab.classList.remove('active'));
          subTabContents.forEach(content => content.classList.remove('active'));
          
          // Seçilen alt tabı ve içeriğini aktif yap
          document.querySelector(`.sub-tab[data-subtab="${subTabId}"]`).classList.add('active');
          document.getElementById(subTabId).classList.add('active');
        }
        
        // Formalize Et butonuna tıklanınca çalışacak fonksiyon
        // Bu kısmı yorum satırına aldım çünkü HTML'de de yorum satırına alınmış
        /*
        document
          .getElementById("formalizeButton")
          .addEventListener("click", async function () {
            let res = window.confirm("Formalize etmek istediginden eminmisin!!!");
            if (!res) {
              console.log("KAbul edilmedi");
              return;
            }
            try {
              const res = await fetch(
                `${BASE_URL}/helal-kontrol/normalize-fields`,
                {
                  method: "PUT",
                }
              );

              const result = await res.text(); // String dönecek
              document.getElementById("formalizeResponse").innerText =
                "Sonuç: " + result;
            } catch (err) {
              document.getElementById("formalizeResponse").innerText =
                "Hata: " + err.message;
            }
          });
        */
        
        // Verileri çek ve textarea'lara yerleştir
        async function fetchAndFillData() {
          try {
            const res = await fetch(
              `${BASE_URL}/helal-kontrol/base-talimat`
            );
            if (!res.ok) throw new Error("Kayıt bulunamadı");
            const data = await res.json();

            // Her alanı doldur
            document.getElementById("baseTalimat").value = data.baseTalimat || "";
            document.getElementById("detayliTalimat").value =
              data.detayliTalimat || "";
            document.getElementById("eCode").value = data.eCode || "";
            document.getElementById("alcoholWords").value =
              data.alcoholWords || "";
            document.getElementById("containingAlcohol").value =
              data.containingAlcohol || "";
            document.getElementById("animalProduct").value =
              data.animalProduct || "";
            document.getElementById("notConsideredAlcohol").value =
              data.notConsideredAlcohol || "";

            document.getElementById("response").innerText = "Veriler yüklendi.";
          } catch (err) {
            document.getElementById("response").innerText =
              "Hata: " + err.message;
          }
        }

        // Güncelleme işlemi
        document
          .getElementById("helalForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const data = {
              baseTalimat: document.getElementById("baseTalimat").value,
              detayliTalimat: document.getElementById("detayliTalimat").value,
              eCode: document.getElementById("eCode").value || null,
              alcoholWords: document.getElementById("alcoholWords").value || null,
              containingAlcohol:
                document.getElementById("containingAlcohol").value || null,
              animalProduct:
                document.getElementById("animalProduct").value || null,
              notConsideredAlcohol:
                document.getElementById("notConsideredAlcohol").value || null,
            };

            try {
              const res = await fetch(
                `${BASE_URL}/helal-kontrol`,
                {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(data),
                }
              );

              const result = await res.json();
              document.getElementById("response").innerText =
                "Güncellendi:\n" + JSON.stringify(result, null, 2);
            } catch (err) {
              document.getElementById("response").innerText =
                "Güncelleme hatası: " + err.message;
            }
          });

        // Yapay Zeka Kelimeleri tabı aktif olduğunda verileri çek
        document.querySelector('.tab[data-tab="tab1"]').addEventListener('click', fetchAndFillData);
        
        // Token Kullanım tabı aktif olduğunda verileri çek
        document.querySelector('.tab[data-tab="tab3"]').addEventListener('click', fetchTokenUsageData);
        
        // Token kullanım verilerini çek ve tabloya yerleştir
        async function fetchTokenUsageData() {
          try {
            const tokenTableBody = document.getElementById('tokenTableBody');
            const totalTokenSum = document.getElementById('totalTokenSum');
            const totalCheckCallSum = document.getElementById('totalCheckCallSum');
            const tokenChart = document.getElementById('tokenChart');
            
            // Yükleniyor mesajını göster
            tokenTableBody.innerHTML = '<tr><td colspan="3" class="loading-message">Veriler yükleniyor...</td></tr>';
            totalTokenSum.innerText = 'Yükleniyor...';
            totalCheckCallSum.innerText = 'Yükleniyor...';
            tokenChart.innerHTML = '<div class="chart-loading">Grafik yükleniyor...</div>';
            
            // API'den verileri çek
            const response = await fetch(`${BASE_URL}/used-stor`);
            
            if (!response.ok) {
              throw new Error('Veriler alınırken bir hata oluştu');
            }
            
            const data = await response.json();
            
            // Verileri tarihe göre sırala (en yeniden en eskiye)
            data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Toplam değerleri hesapla
            let tokenSumTotal = 0;
            let checkCallSumTotal = 0;
            
            data.forEach(item => {
              tokenSumTotal += item.totalTokenCount;
              checkCallSumTotal += item.checkCallCount;
            });
            
            // Toplam değerleri göster
            totalTokenSum.innerText = tokenSumTotal.toLocaleString();
            totalCheckCallSum.innerText = checkCallSumTotal.toLocaleString();
            
            // Son 7 gün için tarih aralığı oluştur (bugün dahil)
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Bugünün sonuna ayarla
            
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 6); // 7 gün için 6 gün öncesi
            oneWeekAgo.setHours(0, 0, 0, 0); // Günün başına ayarla
            
            // Son 7 gün için boş günlük veri yapısı oluştur
            const dailyData = {};
            
            // Son 7 günün her biri için boş kayıtlar oluştur
            for (let i = 0; i < 7; i++) {
              const date = new Date(oneWeekAgo);
              date.setDate(date.getDate() + i);
              const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD formatında
              
              dailyData[dateStr] = {
                date: new Date(date),
                totalTokenCount: 0,
                checkCallCount: 0
              };
            }
            
            // Tarih karşılaştırma için yardımcı fonksiyon
            function isSameDay(date1, date2) {
              return date1.getFullYear() === date2.getFullYear() &&
                     date1.getMonth() === date2.getMonth() &&
                     date1.getDate() === date2.getDate();
            }
            
            // Son 7 gün içindeki verileri filtrele
            const lastWeekData = data.filter(item => {
              const itemDate = new Date(item.createdAt);
              
              // Son 7 gün içindeki herhangi bir güne ait mi kontrol et
              for (let i = 0; i < 7; i++) {
                const checkDate = new Date(oneWeekAgo);
                checkDate.setDate(checkDate.getDate() + i);
                
                if (isSameDay(itemDate, checkDate)) {
                  return true;
                }
              }
              
              return false;
            });
            
            // Verileri günlere göre grupla
            lastWeekData.forEach(item => {
              // Tarih karşılaştırma için her bir günü kontrol et
              for (const dateStr in dailyData) {
                const currentDate = dailyData[dateStr].date;
                const itemDate = new Date(item.createdAt);
                
                if (isSameDay(currentDate, itemDate)) {
                  dailyData[dateStr].totalTokenCount += item.totalTokenCount;
                  dailyData[dateStr].checkCallCount += item.checkCallCount;
                  break;
                }
              }
            });
            
            // Günlük verileri diziye dönüştür ve tarihe göre sırala
            const dailyDataArray = Object.values(dailyData);
            dailyDataArray.sort((a, b) => a.date - b.date);
            
            // Grafik için maksimum değeri bul (10000'in katları olacak şekilde)
            let maxTokenCount = Math.max(...dailyDataArray.map(item => item.totalTokenCount), 10000);
            maxTokenCount = Math.ceil(maxTokenCount / 10000) * 10000;
            
            // Grafik için Y ekseni etiketlerini oluştur
            const yAxisLabels = [];
            for (let i = 0; i <= 5; i++) {
              yAxisLabels.push(Math.round(maxTokenCount * i / 5).toLocaleString());
            }
            
            // Grafik içeriğini oluştur
            let chartHTML = `
              <div class="chart-y-axis">
                ${yAxisLabels.reverse().map(label => `<div class="y-axis-label">${label}</div>`).join('')}
              </div>
            `;
            
            // Eğer veri yoksa mesaj göster
            if (dailyDataArray.length === 0) {
              tokenChart.innerHTML = '<div class="chart-loading">Son 1 hafta için veri bulunamadı</div>';
            } else {
              // Her gün için sütunları oluştur
              dailyDataArray.forEach(dayData => {
                const tokenBarHeight = (dayData.totalTokenCount / maxTokenCount) * 100;
                const checkBarHeight = (dayData.checkCallCount / maxTokenCount) * 100;
                
                const formattedDate = dayData.date.toLocaleDateString('tr-TR', {
                  day: 'numeric',
                  month: 'short'
                }) + (isSameDay(dayData.date, new Date()) ? ' (Bugün)' : '');
                
                chartHTML += `
                  <div class="chart-bar-group">
                    <div class="chart-bars">
                      <div class="chart-bar token-bar" style="height: ${tokenBarHeight}%" title="${dayData.totalTokenCount.toLocaleString()} token"></div>
                      <div class="chart-bar check-bar" style="height: ${checkBarHeight}%" title="${dayData.checkCallCount.toLocaleString()} kontrol"></div>
                    </div>
                    <div class="chart-date">${formattedDate}</div>
                  </div>
                `;
              });
              
              tokenChart.innerHTML = chartHTML;
            }
            
            // Tablo içeriğini oluştur
            if (data.length === 0) {
              tokenTableBody.innerHTML = '<tr><td colspan="3" class="loading-message">Veri bulunamadı</td></tr>';
            } else {
              tokenTableBody.innerHTML = '';
              
              data.forEach(item => {
                const row = document.createElement('tr');
                
                // Tarihi formatla
                const date = new Date(item.createdAt);
                const formattedDate = date.toLocaleDateString('tr-TR', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
                
                row.innerHTML = `
                  <td>${formattedDate}</td>
                  <td>${item.totalTokenCount.toLocaleString()}</td>
                  <td>${item.checkCallCount.toLocaleString()}</td>
                `;
                
                tokenTableBody.appendChild(row);
              });
            }
          } catch (error) {
            console.error('Token kullanım verileri alınırken hata:', error);
            document.getElementById('tokenTableBody').innerHTML = 
              `<tr><td colspan="3" class="loading-message">Hata: ${error.message}</td></tr>`;
            document.getElementById('totalTokenSum').innerText = 'Hata';
            document.getElementById('totalCheckCallSum').innerText = 'Hata';
            document.getElementById('tokenChart').innerHTML = 
              `<div class="chart-loading">Hata: ${error.message}</div>`;
          }
        }
        
        // Sayfa yüklendiğinde verileri çek (hangi tab aktifse)
        if (document.querySelector('.tab[data-tab="tab1"]').classList.contains('active')) {
          fetchAndFillData();
        } else if (document.querySelector('.tab[data-tab="tab3"]').classList.contains('active')) {
          fetchTokenUsageData();
        }
      });
    </script>
  </body>
</html>
